<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audiobook Factory</title>
  <link rel="stylesheet" href="/static/dashboard.css">
</head>

<body>
  <aside class="sidebar">
    <div>
      <h1>Audiobook Factory</h1>
      <p class="text-muted">Generate high-quality speech locally.</p>
    </div>

    <section>
      <h3>Upload & Split</h3>
      <form method="post" action="/upload" enctype="multipart/form-data" class="form-group">
        <input type="file" name="file" accept=".txt" />
        <button type="submit" class="btn btn-primary">Upload Text</button>
      </form>
    </section>

    <section>
      <h3>Queue Controls</h3>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <form method="post" action="/queue/start_xtts">
          <button type="submit" class="btn btn-outline" style="width: 100%;">
            Start XTTS Queue
          </button>
        </form>

        <form method="post" action="/queue/start_piper">
          <div class="form-group" style="margin-bottom: 8px;">
            <select name="piper_voice" style="width: 100%;">
              <option value="">(Select Piper Voice)</option>
              {% for v in piper_voices %}<option value="{{ v }}">{{ v }}</option>{% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-outline" style="width: 100%;">
            Start Piper Queue
          </button>
        </form>

        <form method="post" action="/queue/pause">
          <button type="submit" class="btn btn-outline" style="width: 100%;">
            {{ "️▶️ Resume" if paused else "⏸ Pause" }} Queue
          </button>
        </form>

        <div>
          <button type="button" onclick="handleClear()" class="btn btn-danger" style="width: 100%;">
            Clear All / Reset
          </button>
        </div>

        <div>
          <button type="button" id="backfillBtn" onclick="runBackfill(this)" class="btn btn-secondary"
            style="width: 100%; margin-top: 12px;" {% if (xtts_wav_only|length + piper_wav_only|length)==0 %}disabled{%
            endif %}>
            Resolve Missing MP3s
          </button>
        </div>
      </div>
    </section>

    <section>
      <h3>Settings</h3>
      <form method="post" action="/settings" class="form-group">
        <label class="text-muted">
          <input type="checkbox" name="safe_mode" value="1" {% if settings.safe_mode %}checked{% endif %} />
          Safe Mode (Auto-split)
        </label>
        <label class="text-muted">
          <input type="checkbox" name="make_mp3" value="1" {% if settings.make_mp3 %}checked{% endif %} />
          Make MP3
        </label>
        <div style="margin-top: 12px;">
          <button type="submit" class="btn btn-outline" style="width: 100%;">Save Settings</button>
        </div>
      </form>
    </section>

    <div style="margin-top: auto;">
      <p class="text-muted" style="font-size: 0.75rem;">
        Narrator Sample:
        {% if narrator_ok %}<span style="color: var(--success)">Found</span>
        {% else %}<span style="color: var(--error)">Missing</span>{% endif %}
      </p>
    </div>
  </aside>

  <main class="main-content">
    <header class="content-header">
      <div>
        <h3>Chapters</h3>
        <p class="text-muted">{{ chapters|length }} files ready for processing</p>
      </div>
      <div style="display: flex; align-items: center; gap: 16px;">
        <div class="btn-group"
          style="display: flex; gap: 4px; background: var(--glass); padding: 4px; border-radius: 8px;">
          <button class="btn btn-outline" id="gridToggle"
            style="padding: 6px 12px; font-size: 0.8rem; background: var(--accent); border: none;">Grid</button>
          <button class="btn btn-outline" id="listToggle"
            style="padding: 6px 12px; font-size: 0.8rem; border: none;">List</button>
        </div>
        <div id="globalStatus" class="text-muted">
          <!-- Status summary will be injected here -->
        </div>
      </div>
    </header>

    <div class="chapter-grid-container" id="chapterGrid">
      {% for c in chapters %}
      {% set stem = c.rsplit('.', 1)[0] %}
      <div class="chapter-card" id="card-{{ c }}" data-filename="{{ c }}">
        <div class="card-header">
          <span class="chapter-title">{{ c }}</span>
          <div class="status-badge-container" id="badge-{{ c }}">
            <!-- Badges injected by JS -->
          </div>
        </div>

        <div class="progress-container" id="progress-container-{{ c }}" style="display: none;">
          <div class="progress-bar" id="progress-bar-{{ c }}" style="width: 0%;"></div>
        </div>

        <div class="card-footer" id="footer-{{ c }}">
          {% if c in xtts_mp3 or c in piper_mp3 %}
          {% set engine_path = "/out/xtts/" if c in xtts_mp3 else "/out/piper/" %}
          <audio controls preload="none" src="{{ engine_path }}{{ stem }}.mp3"></audio>
          {% elif c in xtts_wav_only or c in piper_wav_only %}
          <p class="badge badge-wav" style="font-size: 0.75rem; padding: 4px 8px;">WAV Generated (MP3 Missing)</p>
          {% else %}
          <p class="text-muted" style="font-size: 0.8rem;">Ready.</p>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="log-panel" id="logPanel">
      <div class="panel-tabs">
        <div class="tab active" id="logTab">Logs</div>
        <div class="tab" id="previewTab">Preview & Analyze</div>
      </div>

      <div class="tab-content active" id="logContent">
        <div class="log-header">
          <span class="log-title" id="logTitle">System Console</span>
          <span class="text-muted" style="font-size: 0.7rem;">Click a card to see detailed logs</span>
        </div>
        <div class="log-console" id="logConsole">Welcome to Audiobook Factory. Select a job to view real-time output.
        </div>
      </div>

      <div class="tab-content" id="previewContent">
        <div class="preview-header">
          <span class="preview-title" id="previewTitle">Chapter Preview</span>
          <button type="button" onclick="runAnalysis(event)" class="btn btn-outline"
            style="padding: 4px 10px; font-size: 0.7rem;">
            Run Long Sentence Analysis
          </button>
        </div>
        <div class="preview-area" id="previewArea">Select a chapter to see its preview.</div>
      </div>
    </div>
  </main>

  <script>
    let currentSelectedCard = null;
    let jobData = {};

    function esc(s) {
      return (s ?? "").toString()
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function updateCardStatus(filename, job) {
      const badgeCont = document.getElementById(`badge-${filename}`);
      const progCont = document.getElementById(`progress-container-${filename}`);
      const progBar = document.getElementById(`progress-bar-${filename}`);
      const footer = document.getElementById(`footer-${filename}`);
      const card = document.getElementById(`card-${filename}`);

      if (!badgeCont) return;

      if (job) {
        // Status badge
        let statusClass = `badge-${job.status}`;
        badgeCont.innerHTML = `<span class="badge ${statusClass}">${job.status}</span>`;

        // Progress bar
        if (job.status === 'running' || job.status === 'queued') {
          progCont.style.display = 'block';
          progBar.style.width = `${Math.round((job.progress || 0) * 100)}%`;
        } else {
          progCont.style.display = 'none';
        }

        // Audio player if done
        if (job.status === 'done' && job.output_mp3) {
          const enginePath = job.engine === 'xtts' ? '/out/xtts/' : '/out/piper/';
          if (!footer.querySelector('audio')) {
            const encoded = encodeURIComponent(job.output_mp3);
            footer.innerHTML = `<audio controls preload="none" src="${enginePath}${encoded}"></audio>`;
          }
        } else if (job.status === 'wav') {
          footer.innerHTML = `<p class="badge badge-wav" style="font-size: 0.75rem; padding: 4px 8px;">WAV Generated (MP3 Missing)</p>`;
        } else if (job.status === 'failed') {
          footer.innerHTML = `<p class="badge badge-failed" style="font-size: 0.7rem; padding: 2px 6px;">Error: ${esc(job.error)}</p>`;
        }

        // Update log if this is the selected card AND log tab is active
        if (currentSelectedCard === filename && document.getElementById('logTab').classList.contains('active')) {
          const consoleEl = document.getElementById('logConsole');
          const title = document.getElementById('logTitle');
          title.innerText = `Logs: ${filename} (${job.engine})`;
          consoleEl.innerText = job.log || "No logs available yet.";
          consoleEl.scrollTop = consoleEl.scrollHeight;
        }
      }
    }

    async function refreshJobs() {
      try {
        const r = await fetch("/api/jobs", { cache: "no-store" });
        if (!r.ok) return;
        const jobs = await r.json();

        jobData = {};
        jobs.forEach(j => {
          if (!jobData[j.chapter_file] || j.created_at > jobData[j.chapter_file].created_at) {
            jobData[j.chapter_file] = j;
          }
        });

        document.querySelectorAll('.chapter-card').forEach(card => {
          const filename = card.dataset.filename;
          updateCardStatus(filename, jobData[filename]);
        });

        const running = jobs.filter(j => j.status === 'running').length;
        const queued = jobs.filter(j => j.status === 'queued').length;
        const wavs = Object.values(jobData).filter(j => j.status === 'wav').length;

        document.getElementById('globalStatus').innerText =
          `${running} Running • ${queued} Queued • ${wavs} Missing MP3s`;

        const backfillBtn = document.getElementById('backfillBtn');
        if (backfillBtn) {
          if (backfillBtn.innerText !== "Resolving...") {
            backfillBtn.disabled = (wavs === 0);
          }
        }

      } catch (e) {
        console.error("Refresh failed", e);
      }
    }

    // Event Listeners
    document.getElementById('chapterGrid').addEventListener('click', async (e) => {
      const card = e.target.closest('.chapter-card');
      if (!card) return;

      if (currentSelectedCard) {
        document.getElementById(`card-${currentSelectedCard}`)?.classList.remove('active');
      }

      currentSelectedCard = card.dataset.filename;
      card.classList.add('active');

      // Update Log Tab
      const job = jobData[currentSelectedCard];
      const consoleEl = document.getElementById('logConsole');
      const logTitle = document.getElementById('logTitle');
      if (job) {
        logTitle.innerText = `Logs: ${currentSelectedCard} (${job.engine})`;
        consoleEl.innerText = job.log || "No logs available yet.";
      } else {
        logTitle.innerText = `System Console`;
        consoleEl.innerText = `No job record for ${currentSelectedCard}.`;
      }
      consoleEl.scrollTop = consoleEl.scrollHeight;

      // Update Preview/Analysis Tab
      restorePreview();
    });

    document.getElementById('gridToggle').addEventListener('click', () => {
      document.getElementById('chapterGrid').classList.remove('list-view');
      document.getElementById('gridToggle').style.background = 'var(--accent)';
      document.getElementById('listToggle').style.background = 'transparent';
    });

    document.getElementById('listToggle').addEventListener('click', () => {
      document.getElementById('chapterGrid').classList.add('list-view');
      document.getElementById('listToggle').style.background = 'var(--accent)';
      document.getElementById('gridToggle').style.background = 'transparent';
    });

    document.getElementById('logTab').addEventListener('click', () => {
      document.getElementById('logTab').classList.add('active');
      document.getElementById('previewTab').classList.remove('active');
      document.getElementById('logContent').classList.add('active');
      document.getElementById('previewContent').classList.remove('active');
    });

    document.getElementById('previewTab').addEventListener('click', () => {
      document.getElementById('previewTab').classList.add('active');
      document.getElementById('logTab').classList.remove('active');
      document.getElementById('previewContent').classList.add('active');
      document.getElementById('logContent').classList.remove('active');
    });

    async function runAnalysis(e) {
      if (!currentSelectedCard) {
        alert("Please select a chapter first.");
        return;
      }
      const area = document.getElementById('previewArea');
      area.innerText = "Running analysis...";
      try {
        const formData = new FormData();
        formData.append('chapter_file', currentSelectedCard);
        formData.append('ajax', 'true');
        const resp = await fetch('/analyze_long', { method: 'POST', body: formData });
        const data = await resp.json();
        area.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
            <span style="font-weight: 600; color: var(--accent);">Analysis Report</span>
            <button class="btn btn-outline" style="padding: 2px 8px; font-size: 0.7rem;" onclick="restorePreview()">Back to Preview</button>
          </div>
          <div class="report-view">${esc(data.report)}</div>
        `;
      } catch (err) {
        area.innerText = "Analysis failed.";
      }
    }

    async function restorePreview() {
      if (!currentSelectedCard) return;
      document.getElementById('previewTitle').innerText = `Preview: ${currentSelectedCard}`;
      const area = document.getElementById('previewArea');
      area.innerText = "Loading preview...";
      try {
        const resp = await fetch(`/api/preview/${encodeURIComponent(currentSelectedCard)}`);
        const data = await resp.json();
        area.innerText = data.text || "No preview available.";
      } catch (err) {
        area.innerText = "Failed to load preview.";
      }
    }

    async function runBackfill(btn) {
      const originalText = btn.innerText;
      btn.innerText = "Resolving...";
      btn.disabled = true;
      try {
        const resp = await fetch('/queue/backfill_mp3', { method: 'POST' });
        const data = await resp.json();
        alert(`Resolved ${data.converted} files. ${data.failed} failures.`);
        refreshJobs();
      } catch (err) {
        alert("Failed to run backfill.");
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    }

    async function handleClear() {
      if (!confirm('Clear all job history and reset the queue?')) return;

      // Immediate UI reset
      jobData = {};
      currentSelectedCard = null;

      // Clear status badges and progress bars
      document.querySelectorAll('.status-badge-container').forEach(el => el.innerHTML = '');
      document.querySelectorAll('.progress-container').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.chapter-card').forEach(el => {
        el.classList.remove('active');
        const footer = el.querySelector('.card-footer');
        if (footer && (footer.querySelector('.badge-failed') || footer.querySelector('p'))) {
          footer.innerHTML = '<p class="text-muted" style="font-size: 0.8rem;">Ready.</p>';
        }
      });

      // Reset bottom panel
      document.getElementById('logConsole').innerText = 'Queue cleared.';
      document.getElementById('logTitle').innerText = 'System Console';
      document.getElementById('previewTitle').innerText = 'Chapter Preview';
      document.getElementById('previewArea').innerText = 'Select a chapter to see its preview.';
      document.getElementById('globalStatus').innerText = '0 Running • 0 Queued';

      try {
        await fetch('/queue/clear', { method: 'POST' });
        setTimeout(refreshJobs, 100);
      } catch (err) {
        console.error("Failed to clear backend", err);
      }
    }
    refreshJobs();
    setInterval(refreshJobs, 1000);
  </script>
</body>

</html>