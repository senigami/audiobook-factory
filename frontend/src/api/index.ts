import type { Job, Project, Chapter } from '../types';

export const api = {
  // --- Projects ---
  fetchProjects: async (): Promise<Project[]> => {
    const res = await fetch('/api/projects');
    return res.json();
  },
  fetchProject: async (id: string): Promise<Project> => {
    const res = await fetch(`/api/projects/${id}`);
    return res.json();
  },
  createProject: async (data: { name: string; series?: string; author?: string; cover?: File }): Promise<{ status: string; project_id: string }> => {
    const formData = new FormData();
    formData.append('name', data.name);
    if (data.series) formData.append('series', data.series);
    if (data.author) formData.append('author', data.author);
    if (data.cover) formData.append('cover', data.cover);
    const res = await fetch('/api/projects', { method: 'POST', body: formData });
    return res.json();
  },
  updateProject: async (id: string, data: { name?: string; series?: string; author?: string; cover?: File }): Promise<any> => {
    const formData = new FormData();
    if (data.name) formData.append('name', data.name);
    if (data.series) formData.append('series', data.series);
    if (data.author) formData.append('author', data.author);
    if (data.cover) formData.append('cover', data.cover);
    const res = await fetch(`/api/projects/${id}`, { method: 'PUT', body: formData });
    return res.json();
  },
  deleteProject: async (projectId: string): Promise<any> => {
    const res = await fetch(`/api/projects/${projectId}`, { method: 'DELETE' });
    return res.json();
  },
  assembleProject: async (projectId: string, chapterIds?: string[]): Promise<any> => {
    const formData = new FormData();
    if (chapterIds) {
        formData.append('chapter_ids', JSON.stringify(chapterIds));
    }
    const res = await fetch(`/api/projects/${projectId}/assemble`, { method: 'POST', body: formData });
    return res.json();
  },

  // --- Characters ---
  fetchCharacters: async (projectId: string): Promise<import('../types').Character[]> => {
    const res = await fetch(`/api/projects/${projectId}/characters`);
    const data = await res.json();
    return data.characters || [];
  },
  createCharacter: async (projectId: string, name: string, speaker_profile_name?: string, default_emotion?: string, color?: string): Promise<{status: string, character_id: string}> => {
    const formData = new FormData();
    formData.append('name', name);
    if (speaker_profile_name) formData.append('speaker_profile_name', speaker_profile_name);
    if (default_emotion) formData.append('default_emotion', default_emotion);
    if (color) formData.append('color', color);
    const res = await fetch(`/api/projects/${projectId}/characters`, { method: 'POST', body: formData });
    return res.json();
  },
  updateCharacter: async (characterId: string, name?: string, speaker_profile_name?: string, default_emotion?: string, color?: string): Promise<{status: string}> => {
    const formData = new FormData();
    if (name) formData.append('name', name);
    // Allowing empty strings to clear the profile
    if (speaker_profile_name !== undefined) formData.append('speaker_profile_name', speaker_profile_name);
    if (default_emotion !== undefined) formData.append('default_emotion', default_emotion);
    if (color !== undefined) formData.append('color', color);
    const res = await fetch(`/api/characters/${characterId}`, { method: 'PUT', body: formData });
    return res.json();
  },
  deleteCharacter: async (characterId: string): Promise<{status: string}> => {
    const res = await fetch(`/api/characters/${characterId}`, { method: 'DELETE' });
    return res.json();
  },

  // --- Chapters ---
  fetchChapters: async (projectId: string): Promise<Chapter[]> => {
    const res = await fetch(`/api/projects/${projectId}/chapters`);
    return res.json();
  },
  createChapter: async (projectId: string, data: { title: string; text_content?: string; sort_order?: number; file?: File }): Promise<{status: string, chapter: Chapter}> => {
    const formData = new FormData();
    formData.append('title', data.title);
    if (data.text_content) formData.append('text_content', data.text_content);
    formData.append('sort_order', (data.sort_order || 0).toString());
    if (data.file) formData.append('file', data.file);
    const res = await fetch(`/api/projects/${projectId}/chapters`, { method: 'POST', body: formData });
    return res.json();
  },
  updateChapter: async (chapterId: string, data: { title?: string; text_content?: string }): Promise<{status: string, chapter: Chapter}> => {
    const formData = new FormData();
    if (data.title) formData.append('title', data.title);
    if (data.text_content) formData.append('text_content', data.text_content);
    const res = await fetch(`/api/chapters/${chapterId}`, { method: 'PUT', body: formData });
    return res.json();
  },
  deleteChapter: async (chapterId: string): Promise<{ status: string }> => {
    const res = await fetch(`/api/chapters/${chapterId}`, { method: 'DELETE' });
    return res.json();
  },
  reorderChapters: async (projectId: string, chapterIds: string[]): Promise<{ status: string }> => {
    const formData = new FormData();
    formData.append('chapter_ids', JSON.stringify(chapterIds));
    const res = await fetch(`/api/projects/${projectId}/reorder_chapters`, { method: 'POST', body: formData });
    return res.json();
  },
  analyzeChapter: async (chapterId: string): Promise<any> => {
    const res = await fetch(`/api/chapters/${chapterId}/analyze`);
    return res.json();
  },

  // --- Segments ---
  fetchSegments: async (chapterId: string): Promise<import('../types').ChapterSegment[]> => {
    const res = await fetch(`/api/chapters/${chapterId}/segments`);
    const data = await res.json();
    return data.segments || [];
  },
  updateSegment: async (segmentId: string, data: { character_id?: string | null; audio_status?: string }): Promise<any> => {
    const formData = new FormData();
    if (data.character_id !== undefined) formData.append('character_id', data.character_id || "");
    if (data.audio_status) formData.append('audio_status', data.audio_status);
    const res = await fetch(`/api/segments/${segmentId}`, { method: 'PUT', body: formData });
    return res.json();
  },
  updateSegmentsBulk: async (segmentIds: string[], data: { character_id?: string | null; audio_status?: string }): Promise<any> => {
    const formData = new FormData();
    formData.append('segment_ids', segmentIds.join(','));
    if (data.character_id !== undefined) formData.append('character_id', data.character_id || "");
    if (data.audio_status) formData.append('audio_status', data.audio_status);
    const res = await fetch('/api/segments', { method: 'PUT', body: formData });
    return res.json();
  },
  generateSegments: async (segmentIds: string[]): Promise<any> => {
    const formData = new FormData();
    formData.append('segment_ids', segmentIds.join(','));
    const res = await fetch('/api/segments/generate', { method: 'POST', body: formData });
    return res.json();
  },
  bakeChapter: async (chapterId: string): Promise<any> => {
    const res = await fetch(`/api/chapters/${chapterId}/bake`, { method: 'POST' });
    return res.json();
  },
  cancelChapterGeneration: async (chapterId: string): Promise<any> => {
    const res = await fetch(`/api/chapters/${chapterId}/cancel`, { method: 'POST' });
    return res.json();
  },

  // --- Jobs ---
  fetchJobs: async (): Promise<Job[]> => {
    const res = await fetch('/api/jobs');
    return res.json();
  },
  fetchActiveJob: async (): Promise<Job | null> => {
    const res = await fetch('/api/active_job');
    return res.json();
  },
  fetchJobDetails: async (filename: string): Promise<Job | null> => {
    const res = await fetch(`/api/job/${encodeURIComponent(filename)}`);
    return res.json();
  },
  fetchPreview: async (filename: string, processed: boolean = false): Promise<{ text: string; error?: string }> => {
    const res = await fetch(`/api/preview/${encodeURIComponent(filename)}?processed=${processed}`);
    return res.json();
  },
  updateTitle: async (filename: string, newTitle: string): Promise<any> => {
    const formData = new FormData();
    formData.append('chapter_file', filename);
    formData.append('new_title', newTitle);
    const res = await fetch('/api/job/update_title', { method: 'POST', body: formData });
    return res.json();
  },
  deleteAudiobook: async (filename: string): Promise<any> => {
    const res = await fetch(`/api/audiobook/${encodeURIComponent(filename)}`, { method: 'DELETE' });
    return res.json();
  },
  resetChapter: async (chapterId: string): Promise<any> => {
    const res = await fetch(`/api/chapters/${chapterId}/reset`, { method: 'POST' });
    return res.json();
  },
  deleteLegacyChapter: async (filename: string): Promise<any> => {
    const res = await fetch(`/api/chapter/${encodeURIComponent(filename)}`, { method: 'DELETE' });
    return res.json();
  },
  enqueueSingle: async (filename: string, engine: 'xtts', voice?: string): Promise<any> => {
    const formData = new FormData();
    formData.append('chapter_file', filename);
    formData.append('engine', engine);
    if (voice) formData.append('voice', voice);
    const res = await fetch('/api/queue/single', { method: 'POST', body: formData });
    return res.json();
  },
  cancelPending: async (): Promise<any> => {
    const res = await fetch('/api/queue/cancel_pending', { method: 'POST' });
    return res.json();
  },
  exportSample: async (filename: string, projectId?: string): Promise<{ url: string; status?: string; message?: string }> => {
    const url = `/api/chapter/${encodeURIComponent(filename)}/export-sample${projectId ? `?project_id=${projectId}` : ''}`;
    const res = await fetch(url, { method: 'POST' });
    return res.json();
  },

  // --- Processing Queue ---
  getProcessingQueue: async (): Promise<any[]> => {
    const res = await fetch('/api/processing_queue');
    return res.json();
  },
  addProcessingQueue: async (projectId: string, chapterId: string, splitPart: number = 0, speakerProfile?: string): Promise<any> => {
    const formData = new FormData();
    formData.append('project_id', projectId);
    formData.append('chapter_id', chapterId);
    formData.append('split_part', splitPart.toString());
    if (speakerProfile) formData.append('speaker_profile', speakerProfile);
    const res = await fetch('/api/processing_queue', { method: 'POST', body: formData });
    return res.json();
  },
  fetchAudiobooks: async (): Promise<any> => {
    const res = await fetch('/api/audiobooks');
    return res.json();
  },
  reorderProcessingQueue: async (queueIds: string[]): Promise<any> => {
    const formData = new FormData();
    formData.append('queue_ids', queueIds.join(','));
    const res = await fetch('/api/processing_queue/reorder', { method: 'PUT', body: formData });
    return res.json();
  },
  removeProcessingQueue: async (queueId: string): Promise<any> => {
    const res = await fetch(`/api/processing_queue/${encodeURIComponent(queueId)}`, { method: 'DELETE' });
    return res.json();
  },
  clearProcessingQueue: async (): Promise<any> => {
    const res = await fetch('/api/processing_queue', { method: 'DELETE' });
    return res.json();
  },
};
